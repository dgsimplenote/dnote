<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DaNote</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen">
  <div class="max-w-xl mx-auto py-8 px-4">
    <h1 class="text-2xl font-bold mb-4 text-center">ğŸ“ DaNote</h1>

    <!-- Post form -->
    <div class="bg-white p-4 rounded-2xl shadow mb-6">
      <textarea id="noteInput" rows="3"
        class="w-full border border-gray-300 rounded-md p-2 focus:ring focus:ring-blue-200"
        placeholder="Write something short..."></textarea>
      <button id="postBtn"
        class="mt-3 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Post</button>
    </div>

    <!-- Notes feed -->
    <div id="notesContainer" class="space-y-4"></div>

    <!-- Load more button -->
    <div class="text-center mt-6">
      <button id="loadMoreBtn" class="bg-gray-200 px-4 py-2 rounded hover:bg-gray-300">Load More</button>
    </div>
  </div>

  <script>
    const notesContainer = document.getElementById('notesContainer');
    const postBtn = document.getElementById('postBtn');
    const noteInput = document.getElementById('noteInput');
    const loadMoreBtn = document.getElementById('loadMoreBtn');

    let offset = 0;
    const limit = 20;

    async function loadNotes(initial = false) {
      const res = await fetch(`/notes?limit=${limit}&offset=${offset}`);
      if (!res.ok) {
        alert('Failed to load notes');
        return;
      }
      const notes = await res.json();
      if (notes.length === 0 && !initial) {
        loadMoreBtn.disabled = true;
        loadMoreBtn.textContent = 'No more notes';
        return;
      }
      for (const n of notes) {
        const el = renderNote(n);
        notesContainer.appendChild(el);
      }
      offset += notes.length;
    }

    function renderNote(note) {
      const wrapper = document.createElement('div');
      wrapper.className = 'bg-white p-4 rounded-xl shadow';

      const textDiv = document.createElement('div');
      textDiv.className = 'mb-2 whitespace-pre-wrap break-words';
      textDiv.textContent = note.t1;
      wrapper.appendChild(textDiv);

      const urls = extractUrls(note.t1);
      for (const url of urls) {
        if (isImage(url)) {
          const img = document.createElement('img');
          img.src = url;
          img.className = 'mt-2 rounded-md max-h-64 object-cover';
          wrapper.appendChild(img);
        } else if (isVideo(url)) {
          const video = document.createElement('video');
          video.src = url;
          video.controls = true;
          video.className = 'mt-2 rounded-md max-h-64';
          wrapper.appendChild(video);
        }
      }

      const date = new Date(note.v1);
      const dateEl = document.createElement('div');
      dateEl.className = 'text-sm text-gray-500 mt-2';
      dateEl.textContent = date.toLocaleString();
      wrapper.appendChild(dateEl);

      return wrapper;
    }

    function extractUrls(text) {
      const urlRegex = /(https?:\/\/[^\s]+)/g;
      return text.match(urlRegex) || [];
    }
    function isImage(url) {
      return /\.(jpg|jpeg|png|gif|webp)$/i.test(url);
    }
    function isVideo(url) {
      return /\.(mp4|webm|mov)$/i.test(url);
    }

    postBtn.addEventListener('click', async () => {
      const text = noteInput.value.trim();
      if (!text) return;

      postBtn.disabled = true;
      const res = await fetch('/notes', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text }),
      });

      if (res.ok) {
        noteInput.value = '';
        notesContainer.innerHTML = '';
        offset = 0;
        loadMoreBtn.disabled = false;
        loadMoreBtn.textContent = 'Load More';
        await loadNotes(true);
      } else {
        alert('Failed to post note');
      }
      postBtn.disabled = false;
    });

    loadMoreBtn.addEventListener('click', () => loadNotes());
    loadNotes(true);
  </script>
</body>
</html>
